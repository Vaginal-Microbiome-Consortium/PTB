#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Created on Thu Sep 21 22:52:03 2017

@author: tarodz
"""
import matplotlib as mpl
#mpl.use('Agg')
import matplotlib.pyplot as plt;
import seaborn as sns;

import pandas as pd;
import numpy as np;
import pickle
import pandas;
from pandas import DataFrame;
import scipy.stats;
import scipy;
from collections import defaultdict;
import statsmodels.stats.multitest;
import sys;

np.random.seed(1234);

np.set_printoptions(precision=3,suppress=True,linewidth=200);

#Open file for reading to remap names

f = open ('Abbrev-Species.csv','r')

#Create dictionary for abbreviations

abbrev = {}

for line in iter(f):

    ln = line.split(",")

    abbrev[ln[0].strip()] = ln[1].strip()

f.close()

def boxPlotAll(x_all,isSignif,y,colName,pAdj,log10='log10-3'):
    
    letters='abcdefghijklmnop';
    
    yp=y>0;
    yn=y<=0;

    fCnt=isSignif.shape[0];
    
    sigCnt=int(np.sum(isSignif));

    f, ax = plt.subplots(nrows=1,ncols=sigCnt, sharex=False, sharey=False)
    
    #color of median
    medianprops = dict(color='white') 
    whiskerprops=dict(color='black',linestyle='-')
    boxprops=dict(color='black')
    
    sI=0;
    
    bplots=[];
    
    print("Blue: TB, Red: PTB")
    print("On the plot, from left to right:")
    for cI in range(0,fCnt):
        if (isSignif[cI]>0):
            
            print(colNames[cI][5:]+" FDR-adjusted p-value:"+str(pAdj[cI]))
        
            x=x_all[:,cI];

            xp=x[yp];
            xn=x[yn];

            nCnt=xn.shape[0];
            pCnt=xp.shape[0];
            
            axC=ax[sI];
            
            medianprops = dict(color='white') 
            whiskerprops=dict(color='black',linestyle='-')
            boxprops=dict(color='black');
            
            yl=xn;
            yr=xp;
            bplt=axC.boxplot((yl,yr), whis='range',labels=['-','+'], sym='',manage_xticks=True,positions=[-0.1,0.6],widths=[0.35,0.35],medianprops=medianprops,notch=False,patch_artist=True,whiskerprops=whiskerprops,boxprops=boxprops)  #whis=[25, 75]


            bplt['boxes'][0].set_facecolor('#4393c3')
            bplt['boxes'][1].set_facecolor('#d6604d')
            if (sI>0):
                axC.spines['left'].set_visible(False)
            axC.spines['right'].set_visible(False)
            axC.spines['top'].set_visible(False)
            axC.spines['bottom'].set_visible(False)
            axC.tick_params(labeltop='off', labelright='off',top='off', right='off')
            if (sI==0):
                if (log10=='log10-5'):
                    axC.set_ylim(ymin=-0.1,ymax=5.1)
                    axC.set_yticks([0,1,2,3,4,5])
                    axC.set_yticklabels(['0',"$10^{-4}$","$10^{-3}$", "$10^{-2}$", "$10^{-1}$", "1"])
                if (log10=='log10-3'):
                    axC.set_ylim(ymin=-0.1,ymax=3.1)
                    axC.set_yticks([0,1,2,3])
                    axC.set_yticklabels(['0', "$10^{-2}$", "$10^{-1}$", "1"])
            else:
                if (log10=='log10-5'):
                    axC.set_ylim(ymin=-0.1,ymax=5.1)
                    axC.set_yticks(())
                if (log10=='log10-3'):
                    axC.set_ylim(ymin=-0.1,ymax=3.1)
                    axC.set_yticks(())
        
              
            axC.set_xlabel(abbrev[colName[cI][5:]], rotation=45) 
            sI=sI+1;

    ax[0].set_ylabel('vaginal 16S rRNA abundance')
    
    plt.show();
        
    return f;





def normalizeX(x,nt):
    x=x.copy();
    if (nt=='raw-3'):
        x[x<0.001]=0;
        return x;
    if (nt=='log10-3'):
        x=x-0.001;
        x[x<0]=0;
        return np.log10((x+0.001)/0.001);

def getMWUPs(x_all,y,log10=False):
    fCnt=x_all.shape[1];

    yp=y>0;
    yn=y<=0;

    xp=x_all[yp];
    xn=x_all[yn];

    p=np.ones((fCnt,))
    fStats=np.zeros((fCnt,100));

    for i in range(0,fCnt):
        try:
            j=0;
            xpf=xp[:,i].flatten();
            xnf=xn[:,i].flatten();
            xaf=x_all[:,i].flatten();

            _,p[i]=scipy.stats.mannwhitneyu(xpf,xnf,alternative='two-sided');

            fStats[i,j+0]=np.mean(xaf);
            fStats[i,j+1]=np.mean(xpf);
            fStats[i,j+2]=np.mean(xnf);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
            fStats[i,j+0]=np.std(xaf);
            fStats[i,j+1]=np.std(xpf);
            fStats[i,j+2]=np.std(xnf);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
            fStats[i,j+0]=np.median(xaf);
            fStats[i,j+1]=np.median(xpf);
            fStats[i,j+2]=np.median(xnf);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
            fStats[i,j+0]=np.percentile(xaf,75);
            fStats[i,j+1]=np.percentile(xpf,75);
            fStats[i,j+2]=np.percentile(xnf,75);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
            fStats[i,j+0]=np.percentile(xaf,25);
            fStats[i,j+1]=np.percentile(xpf,25);
            fStats[i,j+2]=np.percentile(xnf,25);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
            fStats[i,j+0]=np.percentile(xaf,75)-np.percentile(xaf,25);
            fStats[i,j+1]=np.percentile(xpf,75)-np.percentile(xpf,25);
            fStats[i,j+2]=np.percentile(xnf,75)-np.percentile(xnf,25);
            fStats[i,j+3]=fStats[i,j+1]-fStats[i,j+2];
            j=j+4;
        except ValueError:
            pass

    hAdj,pAdj, alphacSidak, alphacBonf=statsmodels.stats.multitest.multipletests(p,alpha=0.05,method='fdr_bh')
    return p,pAdj,fStats;


cstr='config';
cstr=cstr+';'+'featID';
cstr=cstr+';'+'p-adj';
cstr=cstr+';'+'p-raw';

cstr=cstr+';'+'mean_all';
cstr=cstr+';'+'mean_p';
cstr=cstr+';'+'mean_n';
cstr=cstr+';'+'mean_p-n';

cstr=cstr+';'+'std_all';
cstr=cstr+';'+'std_p';
cstr=cstr+';'+'std_n';
cstr=cstr+';'+'std_p-n';

cstr=cstr+';'+'median_all';
cstr=cstr+';'+'median_p';
cstr=cstr+';'+'median_n';
cstr=cstr+';'+'median_p-n';

cstr=cstr+';'+'pct75_all';
cstr=cstr+';'+'pct75_p';
cstr=cstr+';'+'pct75_n';
cstr=cstr+';'+'pct75_p-n';

cstr=cstr+';'+'pct25_all';
cstr=cstr+';'+'pct25_p';
cstr=cstr+';'+'pct25_n';
cstr=cstr+';'+'pct25_p-n';

cstr=cstr+';'+'IQR_all';
cstr=cstr+';'+'IQR_p';
cstr=cstr+';'+'IQR_n';
cstr=cstr+';'+'IQR_p-n';

cstr=cstr+';'+'taxa';
print(cstr);



(x_data,x_clr_data,x_colNames,y_data,t_data,gaSample_all,gaDelivery_all,cl_data,clinical_var_list)=pickle.load(open('data-sets-manuscript/firstVisits-modeling-oneF24V.pkl','rb'))


nonFDRp=0.05;

normType='raw-3';
normType2='log10-3';

x_all_base=x_data;
x_all=normalizeX(x_all_base,normType);
x_all2=normalizeX(x_all_base,normType2);
n_all=x_all.shape[0];
colNames=x_colNames;

expNameCurr='FV'+normType;

pRaw,pAdj,fStats=getMWUPs(x_all,y_data,log10=False);
fCnt=x_all.shape[1];

cntSignif=0;

isSignif=np.zeros((fCnt,))

for cI in range(0,fCnt):
    cn=colNames[cI][5:];
    cn=cn.replace('/','-')
    cstr=expNameCurr;
    cstr=cstr+';'+str(cI);
    cstr=cstr+';'+str(pAdj[cI]);
    if (pAdj[cI]<=0.05):
        cntSignif=cntSignif+1;
        isSignif[cI]=1;
    cstr=cstr+';'+str(pRaw[cI]);
    for sfI in range(0,24):
        cstr=cstr+';'+str(fStats[cI,sfI]);
    cstr=cstr+';'+colNames[cI][5:];
    print(cstr)
    
print("SIGNIF:"+str(cntSignif))


f=boxPlotAll(x_all2,isSignif,y_data,colNames,pAdj,log10=normType2)
f.savefig('paperFigs/Extended-Fig3a.pdf',dpi=600,bbox_inches='tight')#,pad_inches=.05)

    
'''

config;featID;p-adj;p-raw;mean_all;mean_p;mean_n;mean_p-n;std_all;std_p;std_n;std_p-n;median_all;median_p;median_n;median_p-n;pct75_all;pct75_p;pct75_n;pct75_p-n;pct25_all;pct25_p;pct25_n;pct25_p-n;IQR_all;IQR_p;IQR_n;IQR_p-n;taxa
FVraw-3;0;0.5938626544690897;0.4988446297540353;0.31940439343452454;0.3409974277019501;0.30805885791778564;0.03293856978416443;0.3581504225730896;0.35511067509651184;0.35921749472618103;-0.0041068196296691895;0.16056600213050842;0.1614798754453659;0.15303030610084534;0.008449569344520569;0.6480087786912918;0.7099267244338989;0.5740557312965393;0.13587099313735962;0.0047960568917915225;0.015349717810750008;0.0025563228991813958;0.012793394911568612;0.6432127217995003;0.6945770066231489;0.5714994083973579;0.12307759822579101;Lactobacillus_iners
FVraw-3;1;0.11007315484778249;0.0704468191025808;0.16060471534729004;0.0321974940598011;0.2280729115009308;-0.19587541744112968;0.3352033197879791;0.16860097646713257;0.37848028540611267;-0.2098793089389801;0.0;0.0;0.0;0.0;0.0024590371176600456;0.0;0.5179453641176224;-0.5179453641176224;0.0;0.0;0.0;0.0;0.0024590371176600456;0.0;0.5179453641176224;-0.5179453641176224;Lactobacillus_crispatus_cluster
FVraw-3;2;0.0007519146588440375;3.0076586353761502e-05;0.07807929068803787;0.15305839478969574;0.03868347778916359;0.11437491700053215;0.19980838894844055;0.24947530031204224;0.1539250612258911;0.09555023908615112;0.0;0.016490116715431213;0.0;0.016490116715431213;0.0022806441411376;0.203617163002491;0.0;0.203617163002491;0.0;0.0;0.0;0.0;0.0022806441411376;0.203617163002491;0.0;0.203617163002491;Lachnospiraceae_BVAB1
FVraw-3;3;0.14145496932048002;0.09618937913792641;0.1120927482843399;0.12833493947982788;0.10355871170759201;0.02477622777223587;0.15598070621490479;0.1323118656873703;0.1664445549249649;-0.034132689237594604;0.033272918313741684;0.11832601577043533;0.003631448606029153;0.11469456716440618;0.15449562668800354;0.18288357555866241;0.14819873124361038;0.03468484431505203;0.0;0.0;0.0;0.0;0.15449562668800354;0.18288357555866241;0.14819873124361038;0.03468484431505203;Gardnerella_vaginalis
FVraw-3;4;0.08446855890234763;0.05068113534140858;0.07144615054130554;0.05484699085354805;0.080167755484581;-0.025320764631032944;0.16594170033931732;0.0954534113407135;0.1923457682132721;-0.0968923568725586;0.0019005078356713057;0.022259321063756943;0.0;0.022259321063756943;0.05996054317802191;0.06435133516788483;0.05289922654628754;0.01145210862159729;0.0;0.0005167958443053067;0.0;0.0005167958443053067;0.05996054317802191;0.06383453932357952;0.05289922654628754;0.010935312777291983;Atopobium_vaginae
FVraw-3;5;0.015110353092074891;0.003626484742097974;0.030873417854309082;0.05367207154631615;0.018894463777542114;0.03477760776877403;0.06369725614786148;0.088057741522789;0.04121093079447746;0.04684681072831154;0.0020598319824784994;0.013067583553493023;0.0;0.013067583553493023;0.02725467411801219;0.05759518779814243;0.013028861489146948;0.044566326308995485;0.0;0.0;0.0;0.0;0.02725467411801219;0.05759518779814243;0.013028861489146948;0.044566326308995485;Prevotella_cluster2
FVraw-3;6;0.37562605639339924;0.3005008451147194;0.015716861933469772;0.0018764823907986283;0.022988924756646156;-0.021112442365847528;0.06527691334486008;0.007692897226661444;0.0794689804315567;-0.07177608320489526;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;Lactobacillus_jensenii
FVraw-3;7;0.9266151830319317;0.8154213610680999;0.025297828018665314;0.02625994011759758;0.02479230798780918;0.0014676321297883987;0.10768032819032669;0.11244281381368637;0.1050880178809166;0.007354795932769775;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;Lactobacillus_gasseri_cluster
FVraw-3;8;0.039438636084751684;0.014197908990510604;0.020523499697446823;0.024758247658610344;0.01829846389591694;0.006459783762693405;0.0400044284760952;0.03548501059412956;0.04201475530862808;-0.00652974471449852;0.0;0.01658773235976696;0.0;0.01658773235976696;0.02432778850197792;0.03314733225852251;0.015058744233101606;0.018088588025420904;0.0;0.0;0.0;0.0;0.02432778850197792;0.03314733225852251;0.015058744233101606;0.018088588025420904;Megasphaera_OTU70_type1
FVraw-3;9;0.0060769680601675605;0.00048615744481340483;0.017891481518745422;0.025287708267569542;0.01400532852858305;0.011282379738986492;0.06270908564329147;0.05236787348985672;0.06718525290489197;-0.014817379415035248;0.0;0.0036644316278398037;0.0;0.0036644316278398037;0.0028695553774014115;0.02337556704878807;0.0;0.02337556704878807;0.0;0.0;0.0;0.0;0.0028695553774014115;0.02337556704878807;0.0;0.02337556704878807;Sneathia_amnii
FVraw-3;10;0.9561289753224363;0.9178838163095389;0.005921508651226759;0.0025097390171140432;0.007714133244007826;-0.005204394226893783;0.03458515182137489;0.008457008749246597;0.04216279461979866;-0.03370578587055206;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;Prevotella_bivia
FVraw-3;11;0.0534060116351907;0.024423189931184235;0.004516842775046825;0.0046923100017011166;0.004424648825079203;0.0002676611766219139;0.02191922254860401;0.012566380202770233;0.025493074208498;-0.012926694005727768;0.0;0.0;0.0;0.0;0.0;0.0023878514766693115;0.0;0.0023878514766693115;0.0;0.0;0.0;0.0;0.0;0.0023878514766693115;0.0;0.0023878514766693115;Mycoplasma_hominis
FVraw-3;12;0.010102959385450166;0.0016164735016720266;0.006941996514797211;0.007484761998057365;0.00665681529790163;0.000827946700155735;0.02017289213836193;0.013331600464880466;0.02295961044728756;-0.009628009982407093;0.0;0.004019905347377062;0.0;0.004019905347377062;0.004870949080213904;0.00968054449185729;0.001319002767559141;0.00836154172429815;0.0;0.0;0.0;0.0;0.004870949080213904;0.00968054449185729;0.001319002767559141;0.00836154172429815;Dialister_cluster51
FVraw-3;13;0.9561289753224363;0.9113476493184274;0.004142631310969591;0.0026767579838633537;0.0049128360114991665;-0.0022360780276358128;0.013752252794802189;0.00752113526687026;0.016032801941037178;-0.008511666674166918;0.0;0.0;0.0;0.0;0.00296661612810567;0.002114076109137386;0.0035364817595109344;-0.0014224056503735483;0.0;0.0;0.0;0.0;0.00296661612810567;0.002114076109137386;0.0035364817595109344;-0.0014224056503735483;Ureaplasma_cluster23
FVraw-3;14;0.013544537582711555;0.002708907516542311;0.006108081433922052;0.01134941354393959;0.0033541610464453697;0.00799525249749422;0.0226545762270689;0.027307609096169472;0.019211016595363617;0.008096592500805855;0.0;0.0;0.0;0.0;0.0;0.0023519706446677446;0.0;0.0023519706446677446;0.0;0.0;0.0;0.0;0.0;0.0023519706446677446;0.0;0.0023519706446677446;Prevotella_amnii
FVraw-3;15;0.010102959385450166;0.0014200888108921307;0.004689985420554876;0.012174718081951141;0.0007573300390504301;0.011417388042900711;0.022824212908744812;0.03733231499791145;0.004180531483143568;0.033151783514767885;0.0;0.0;0.0;0.0;0.0;0.005823944229632616;0.0;0.005823944229632616;0.0;0.0;0.0;0.0;0.0;0.005823944229632616;0.0;0.005823944229632616;TM7_OTU-H1
FVraw-3;16;0.07320658047164093;0.04099568506411892;0.0056800078600645065;0.007082573603838682;0.004943066742271185;0.0021395068615674973;0.017559880390763283;0.015299954451620579;0.018595458939671516;-0.0032955044880509377;0.0;0.0;0.0;0.0;0.0;0.003490496426820755;0.0;0.003490496426820755;0.0;0.0;0.0;0.0;0.0;0.003490496426820755;0.0;0.003490496426820755;Sneathia_sanguinegens
FVraw-3;17;0.9951510831929519;0.9951510831929519;0.0022239063400775194;0.002636095741763711;0.002007332630455494;0.000628763111308217;0.007664643693715334;0.007813229225575924;0.00757642462849617;0.00023680459707975388;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;Finegoldia_magna
FVraw-3;18;0.04762392898005928;0.019049571592023713;0.00406532222405076;0.00471350597217679;0.0037247512955218554;0.0009887546766549349;0.011156046763062477;0.009887267835438251;0.011753684841096401;-0.0018664170056581497;0.0;0.0;0.0;0.0;0.0017950829933397472;0.005646437406539917;0.0;0.005646437406539917;0.0;0.0;0.0;0.0;0.0017950829933397472;0.005646437406539917;0.0;0.005646437406539917;Clostridiales_BVAB2
FVraw-3;19;0.21497989541277382;0.15478552469719714;0.005988955032080412;0.007566473446786404;0.005160089116543531;0.0024063843302428722;0.014905499294400215;0.01467179972678423;0.014960319735109806;-0.0002885200083255768;0.0;0.0;0.0;0.0;0.004837954533286393;0.006053433287888765;0.002639648737385869;0.0034137845505028963;0.0;0.0;0.0;0.0;0.004837954533286393;0.006053433287888765;0.002639648737385869;0.0034137845505028963;Aerococcus_christensenii
FVraw-3;20;0.0534060116351907;0.025634885584891538;0.0051895324140787125;0.00669871224090457;0.004396574106067419;0.0023021381348371506;0.009412586688995361;0.008860326372087002;0.009595496580004692;-0.0007351702079176903;0.0;0.0025815439876168966;0.0;0.0025815439876168966;0.005849981447681785;0.01126381428912282;0.002373542170971632;0.008890272118151188;0.0;0.0;0.0;0.0;0.005849981447681785;0.01126381428912282;0.002373542170971632;0.008890272118151188;Coriobacteriaceae_OTU27
FVraw-3;21;0.039438636084751684;0.013792063398797778;0.003167404094710946;0.004478791728615761;0.0024783702101558447;0.002000421518459916;0.0074553717859089375;0.007839925587177277;0.007149388547986746;0.0006905370391905308;0.0;0.001793266274034977;0.0;0.001793266274034977;0.002521399816032499;0.004399357829242945;0.0017510515172034502;0.0026483063120394945;0.0;0.0;0.0;0.0;0.002521399816032499;0.004399357829242945;0.0017510515172034502;0.0026483063120394945;Dialister_micraerophilus
FVraw-3;22;0.2555748468460508;0.19423688360299862;0.0040264129638671875;0.006511087995022535;0.0027209052350372076;0.0037901827599853277;0.01768912933766842;0.020411552861332893;0.015920329838991165;0.004491223022341728;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;0.0;Megasphaera_OTU71_type2
FVraw-3;23;0.039438636084751684;0.01193473363580538;0.001983750145882368;0.004005692899227142;0.0009213733719661832;0.003084319527260959;0.004628239665180445;0.006859465502202511;0.002162498887628317;0.004696966614574194;0.0;0.0;0.0;0.0;0.0018832263885997236;0.00536658288910985;0.0;0.00536658288910985;0.0;0.0;0.0;0.0;0.0018832263885997236;0.00536658288910985;0.0;0.00536658288910985;Parvimonas_OTU142
FVraw-3;24;0.06757963328789611;0.03514140930970598;0.0023941481485962868;0.005621135234832764;0.0006986125954426825;0.004922522639390081;0.010981973260641098;0.017612552270293236;0.003554988419637084;0.014057563850656152;0.0;0.0;0.0;0.0;0.0;0.0008211102685891092;0.0;0.0008211102685891092;0.0;0.0;0.0;0.0;0.0;0.0008211102685891092;0.0;0.0008211102685891092;Prevotellaceae_OTU61


SIGNIF:10

Blue: TB, Red: PTB
On the plot, from left to right:

Lachnospiraceae_BVAB1 FDR-adjusted p-value:0.0007519146588440375
Prevotella_cluster2 FDR-adjusted p-value:0.015110353092074891
Megasphaera_OTU70_type1 FDR-adjusted p-value:0.039438636084751684
Sneathia_amnii FDR-adjusted p-value:0.0060769680601675605
Dialister_cluster51 FDR-adjusted p-value:0.010102959385450166
Prevotella_amnii FDR-adjusted p-value:0.013544537582711555
TM7_OTU-H1 FDR-adjusted p-value:0.010102959385450166
Clostridiales_BVAB2 FDR-adjusted p-value:0.04762392898005928
Dialister_micraerophilus FDR-adjusted p-value:0.039438636084751684
Parvimonas_OTU142 FDR-adjusted p-value:0.039438636084751684

￼



'''    